<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi Network Authentication Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-box {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-box h2 {
            color: #7b1fa2;
            margin-top: 0;
        }
        .test-box code {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
        button {
            background: #7b1fa2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #6a1a8f;
        }
        .result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
    </style>
    <!-- Pi SDK -->
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body>
    <h1>ğŸ§ª Pi Network Authentication Test</h1>
    
    <div class="test-box">
        <h2>1ï¸âƒ£ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
        <button onclick="checkSystemInfo()">ÙØ­Øµ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        <div id="system-info" class="result"></div>
    </div>

    <div class="test-box">
        <h2>2ï¸âƒ£ ØªÙ‡ÙŠØ¦Ø© Pi SDK</h2>
        <button onclick="initPiSDK()">ØªÙ‡ÙŠØ¦Ø© Pi SDK</button>
        <div id="init-result" class="result"></div>
    </div>

    <div class="test-box">
        <h2>3ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©</h2>
        <button onclick="testAuthentication()">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©</button>
        <div id="auth-result" class="result"></div>
    </div>

    <div class="test-box">
        <h2>4ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± ÙŠØ¯ÙˆÙŠ ÙÙŠ Console</h2>
        <p>Ø§ÙØªØ­ Console (F12) ÙˆØ§ÙƒØªØ¨:</p>
        <code>
            Pi.authenticate(['username'])<br>
            &nbsp;&nbsp;.then(a => alert('SUCCESS: ' + a.user.username))<br>
            &nbsp;&nbsp;.catch(e => alert('FAILED: ' + JSON.stringify(e)));
        </code>
        <p style="margin-top: 10px; color: #666;">
            <strong>Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©:</strong><br>
            â€¢ Ù„Ø§ ØªØ¸Ù‡Ø± Ù†Ø§ÙØ°Ø© Ù…ÙˆØ§ÙÙ‚Ø© â†’ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Dashboard (URL Ø£Ùˆ Scopes)<br>
            â€¢ ØªØ¸Ù‡Ø± ÙˆØªØºÙ„Ù‚ ÙÙˆØ±Ù‹Ø§ â†’ Scope ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„ Ø£Ùˆ Sandbox<br>
            â€¢ ØªØ¸Ù‡Ø± ÙˆØªÙ†Ø¬Ø­ â†’ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù…Ø­Ù„ÙˆÙ„Ø© âœ…
        </p>
    </div>

    <div class="test-box warning">
        <h2>âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù‡Ù…Ø©</h2>
        <ul>
            <li><strong>GitHub ØºÙŠØ± Ù…Ø·Ù„ÙˆØ¨:</strong> Ø·Ø§Ù„Ù…Ø§ Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ† ÙŠØ¹Ù…Ù„ØŒ GitHub Ù„Ø§ ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©</li>
            <li><strong>App URL:</strong> ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø­Ø±ÙÙŠÙ‹Ø§ <code>https://ledgererp.online</code> ÙÙŠ Dashboard</li>
            <li><strong>Scopes:</strong> ØªØ£ÙƒØ¯ Ø£Ù† "username" Ù…ÙØ¹Ù‘Ù„ ÙÙŠ Dashboard â†’ Permissions/Scopes</li>
            <li><strong>Pi Browser:</strong> ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… Pi Browser ÙÙ‚Ø· (Ù„ÙŠØ³ Chrome/Firefox/etc.)</li>
        </ul>
    </div>

    <script>
        function checkSystemInfo() {
            const info = {
                'Pi SDK loaded': typeof Pi !== 'undefined',
                'Is Pi Browser': /PiBrowser/.test(navigator.userAgent),
                'Current Origin': window.location.origin,
                'Expected Origin': 'https://ledgererp.online',
                'Origin Matches': window.location.origin === 'https://ledgererp.online',
                'User Agent': navigator.userAgent,
                'Has Pi.init': typeof Pi?.init === 'function',
                'Has Pi.authenticate': typeof Pi?.authenticate === 'function',
                'Pi.isInitialized': typeof Pi?.isInitialized === 'function' ? Pi.isInitialized() : 'N/A'
            };

            let html = '<strong>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…:</strong>\n';
            for (const [key, value] of Object.entries(info)) {
                const status = typeof value === 'boolean' ? (value ? 'âœ…' : 'âŒ') : '';
                html += `${key}: ${value} ${status}\n`;
            }

            document.getElementById('system-info').textContent = html;
            document.getElementById('system-info').className = 'result info';
        }

        async function initPiSDK() {
            const resultDiv = document.getElementById('init-result');
            resultDiv.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...';
            resultDiv.className = 'result info';

            try {
                if (typeof Pi === 'undefined') {
                    throw new Error('Pi SDK ØºÙŠØ± Ù…Ø­Ù…Ù‘Ù„! ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ https://sdk.minepi.com/pi-sdk.js');
                }

                await Pi.init({ version: '2.0' });
                resultDiv.textContent = 'âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Pi SDK Ø¨Ù†Ø¬Ø§Ø­!';
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.textContent = `âŒ ÙØ´Ù„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©:\n${error.message}\n\n${error.stack}`;
                resultDiv.className = 'result error';
            }
        }

        async function testAuthentication() {
            const resultDiv = document.getElementById('auth-result');
            resultDiv.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©...';
            resultDiv.className = 'result info';

            try {
                // Check prerequisites
                if (typeof Pi === 'undefined') {
                    throw new Error('Pi SDK ØºÙŠØ± Ù…Ø­Ù…Ù‘Ù„');
                }

                if (!/PiBrowser/.test(navigator.userAgent)) {
                    throw new Error('ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… Pi Browser ÙÙ‚Ø·');
                }

                if (window.location.origin !== 'https://ledgererp.online') {
                    throw new Error(`Origin mismatch: ${window.location.origin} !== https://ledgererp.online`);
                }

                // Initialize if not already initialized
                try {
                    await Pi.init({ version: '2.0' });
                } catch (initError) {
                    // May already be initialized
                    console.log('Init check:', initError.message);
                }

                // Test authentication
                resultDiv.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø·Ù„Ø¨ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©...\n(Ø³ØªØ¸Ù‡Ø± Ù†Ø§ÙØ°Ø© Pi Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø©)';
                resultDiv.className = 'result info';

                const authResult = await Pi.authenticate(['username']);
                
                resultDiv.textContent = `âœ… Ù†Ø¬Ø­Øª Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©!\n\n` +
                    `Username: ${authResult.user?.username || 'N/A'}\n` +
                    `UID: ${authResult.user?.uid || 'N/A'}\n` +
                    `Access Token: ${authResult.accessToken ? 'Present' : 'Missing'}\n\n` +
                    `Full Result:\n${JSON.stringify(authResult, null, 2)}`;
                resultDiv.className = 'result success';

            } catch (error) {
                let errorMsg = `âŒ ÙØ´Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:\n\n${error.message}\n\n`;
                
                // Add specific guidance based on error
                if (error.message.includes('Origin') || error.message.includes('origin')) {
                    errorMsg += 'ğŸ”§ Ø§Ù„Ø­Ù„:\n';
                    errorMsg += '1. Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Pi Developer Portal\n';
                    errorMsg += '2. Ø§ÙØªØ­ ØªØ·Ø¨ÙŠÙ‚Ùƒ\n';
                    errorMsg += '3. ØªØ£ÙƒØ¯ Ø£Ù† App URL = https://ledgererp.online (Ø­Ø±ÙÙŠÙ‹Ø§)\n';
                    errorMsg += '4. Ø§Ø­ÙØ¸ ÙˆØ§Ù†ØªØ¸Ø± 1-2 Ø¯Ù‚ÙŠÙ‚Ø©\n';
                } else if (error.message.includes('Browser')) {
                    errorMsg += 'ğŸ”§ Ø§Ù„Ø­Ù„:\n';
                    errorMsg += 'Ø§ÙØªØ­ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Pi Browser ÙÙ‚Ø·\n';
                } else if (error.message.includes('scope') || error.message.includes('Scope')) {
                    errorMsg += 'ğŸ”§ Ø§Ù„Ø­Ù„:\n';
                    errorMsg += '1. Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Pi Developer Portal\n';
                    errorMsg += '2. Ø§ÙØªØ­ ØªØ·Ø¨ÙŠÙ‚Ùƒ â†’ Permissions/Scopes\n';
                    errorMsg += '3. ÙØ¹Ù‘Ù„ scope "username"\n';
                    errorMsg += '4. Ø§Ø­ÙØ¸ ÙˆØ§Ù†ØªØ¸Ø± 1-2 Ø¯Ù‚ÙŠÙ‚Ø©\n';
                } else {
                    errorMsg += 'ğŸ”§ ØªØ­Ù‚Ù‚ Ù…Ù†:\n';
                    errorMsg += 'â€¢ App URL ÙÙŠ Dashboard = https://ledgererp.online\n';
                    errorMsg += 'â€¢ Scope "username" Ù…ÙØ¹Ù‘Ù„ ÙÙŠ Permissions/Scopes\n';
                    errorMsg += 'â€¢ ØªØ³ØªØ®Ø¯Ù… Pi Browser\n';
                }

                errorMsg += `\n\nStack Trace:\n${error.stack || 'N/A'}`;
                
                resultDiv.textContent = errorMsg;
                resultDiv.className = 'result error';
            }
        }

        // Auto-check on load
        window.addEventListener('load', () => {
            setTimeout(checkSystemInfo, 500);
        });
    </script>
</body>
</html>

